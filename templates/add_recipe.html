{% extends "base.html" %}

{% block title %}Add New Recipe - Br체ggen Innovation Catalogue{% endblock %}

{% block head %}
<style>
/* Recipe Preview Specific Styles */
.ingredient-name {
    font-weight: 500;
    color: #2c3e50;
}

.percentage-cell {
    text-align: right;
    font-weight: 600;
    color: #661c31;
}

.recipe-preview-modal .table {
    margin-bottom: 0;
}

.recipe-preview-modal .table td {
    padding: 12px 16px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
}

.recipe-preview-modal .table th {
    padding: 12px 16px;
    background-color: #661c31;
    color: white;
    border: none;
    font-weight: 600;
}

.recipe-preview-modal .card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.recipe-preview-modal .card-header {
    padding: 16px 20px;
    margin: 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    font-weight: 600;
}

.recipe-preview-modal .card-body {
    padding: 20px;
}

.recipe-preview-modal .badge {
    font-size: 0.875rem;
    padding: 8px 16px;
    border-radius: 6px;
    margin: 4px 2px;
    font-weight: 500;
}

.modal-xl {
    max-width: 1200px;
}

#recipePreviewModal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

/* Recipe List Styles */
.recipe-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.recipe-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.recipe-image-container img {
    transition: transform 0.3s ease;
}

.recipe-card:hover .recipe-image-container img {
    transform: scale(1.05);
}

.delete-recipe-btn:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

/* Image upload hover effects */
.image-preview-wrapper:hover .image-overlay {
    opacity: 1 !important;
}

.image-upload-container {
    transition: transform 0.2s ease;
}

.image-upload-container:hover {
    transform: translateY(-2px);
}

/* Image selection styles */
.image-selection-card:hover .image-selection-overlay {
    opacity: 1 !important;
}

.image-selection-card {
    transition: transform 0.2s ease;
    cursor: pointer;
}

.image-selection-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header py-5">
    <div class="container-fluid px-4">
        <h1 class="page-title">Add New Recipe</h1>
        <p class="text-muted">Upload a document and let AI analyze it to create a new product entry</p>
    </div>
</div>

<div class="container-fluid px-4 py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Upload Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header" style="background-color: #661c31;">
                    <h3 class="card-title mb-0 text-white">
                        <i class="fas fa-upload me-2"></i>Upload Recipe Document
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form id="recipeUploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="recipeFile" class="form-label fw-bold">Recipe Documents</label>
                            <div class="upload-area border border-2 border-dashed rounded-3 p-4 text-center" 
                                 ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event);">
                                <input type="file" class="form-control d-none" id="recipeFile" name="recipe_file" 
                                       accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.xlsx,.jpg,.jpeg,.png" multiple required>
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drag & drop your recipe documents here</h5>
                                    <p class="text-muted">or <a href="#" onclick="document.getElementById('recipeFile').click()">browse files</a></p>
                                    <small class="text-muted">Supported formats: PDF, DOC, DOCX, TXT, PPT, PPTX, XLSX, JPG, PNG<br>Multiple files supported</small>
                                </div>
                                <div class="selected-files d-none">
                                    <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                                    <p class="files-info fw-bold mb-1"></p>
                                    <div class="files-list small text-muted"></div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary px-4" id="analyzeBtn">
                                <i class="fas fa-magic me-2"></i>Analyze with AI
                            </button>
                            <a href="{{ url_for('catalog') }}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Analysis Progress -->
            <div class="card border-0 shadow-sm d-none" id="analysisProgress">
                <div class="card-header" style="background-color: #661c31;">
                    <h3 class="card-title mb-0 text-white">
                        <i class="fas fa-brain me-2"></i>AI Analysis in Progress
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="analysis-steps">
                        <div class="step" data-step="1">
                            <i class="fas fa-file-text me-2"></i>Reading document content...
                        </div>
                        <div class="step" data-step="2">
                            <i class="fas fa-brain me-2"></i>AI analyzing recipe with OpenAI GPT-4...
                        </div>
                        <div class="step" data-step="3">
                            <i class="fas fa-search me-2"></i>Extracting ingredients and percentages...
                        </div>
                        <div class="step" data-step="4">
                            <i class="fas fa-calculator me-2"></i>Processing nutritional information...
                        </div>
                        <div class="step" data-step="5">
                            <i class="fas fa-check-circle me-2"></i>Finalizing product analysis...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Recipes Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header" style="background-color: #661c31;">
                    <h3 class="card-title mb-0 text-white">
                        <i class="fas fa-list me-2"></i>Existing Recipes
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div id="recipesList">
                        {% if recipes %}
                        <div class="row g-3" id="recipesGrid">
                            {% for recipe in recipes %}
                            <div class="col-lg-3 col-md-4 col-sm-6" id="recipe-{{ recipe.id }}">
                                <div class="card h-100 recipe-card">
                                    <div class="recipe-image-container" style="height: 200px; overflow: hidden;">
                                        <img src="{{ recipe.image_url or '/static/images/product-placeholder.png' }}" 
                                             class="card-img-top" alt="{{ recipe.name }}" 
                                             style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title mb-2 text-truncate">{{ recipe.name }}</h6>
                                        <small class="text-muted mb-2">{{ recipe.category }}</small>
                                        <div class="mt-auto">
                                            <button type="button" class="btn btn-outline-danger btn-sm w-100 delete-recipe-btn" 
                                                    data-recipe-id="{{ recipe.id }}" data-recipe-name="{{ recipe.name }}">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No recipes found</h5>
                            <p class="text-muted">Upload your first recipe document to get started!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recipe Preview Modal -->
<div class="modal fade" id="recipePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #661c31;">
                <h5 class="modal-title text-white">
                    <i class="fas fa-eye me-2"></i>Recipe Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="recipePreviewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-warning" id="editRecipeBtn">
                    <i class="fas fa-edit me-2"></i>Edit Data
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" id="saveRecipeBtn">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
                <button type="button" class="btn btn-primary" id="publishRecipeBtn">
                    <i class="fas fa-check me-2"></i>Publish Recipe
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.querySelector('.upload-area');
    const fileInput = document.getElementById('recipeFile');
    const uploadForm = document.getElementById('recipeUploadForm');
    const analysisProgress = document.getElementById('analysisProgress');

    function handleFileSelect(files) {
        if (files && files.length > 0) {
            const uploadContent = uploadArea.querySelector('.upload-content');
            const selectedFiles = uploadArea.querySelector('.selected-files');

            uploadContent.classList.add('d-none');
            selectedFiles.classList.remove('d-none');

            // Update files info
            const filesInfo = selectedFiles.querySelector('.files-info');
            const filesList = selectedFiles.querySelector('.files-list');
            
            filesInfo.textContent = `${files.length} file${files.length > 1 ? 's' : ''} selected`;
            
            // Build files list
            let listHTML = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                listHTML += `<div class="mb-1"><i class="fas fa-file me-1"></i>${file.name} (${formatFileSize(file.size)})</div>`;
            }
            filesList.innerHTML = listHTML;
        }
    }

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files);
    });

    // Form submission handler
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        analyzeRecipe();
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }


    function analyzeRecipe() {
        const files = fileInput.files;
        if (!files || files.length === 0) {
            alert('Please select at least one file first.');
            return;
        }

        // Show analysis progress
        const progressElement = document.getElementById('analysisProgress');
        if (progressElement) {
            progressElement.classList.remove('d-none');
        }

        // Simulate AI analysis progress
        simulateAnalysis();

        // Create FormData and submit all files
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('recipe_file', files[i]);
        }

        fetch('/api/analyze-recipe', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                setTimeout(() => {
                    if (progressElement) {
                        progressElement.classList.add('d-none');
                    }
                    showRecipePreview(data.recipe_data);
                }, 1000); // Small delay to show completion
            } else {
                if (progressElement) {
                    progressElement.classList.add('d-none');
                }
                alert('AI Analysis failed: ' + (data.error || 'Unknown error'));
                console.error('AI Analysis error:', data.error);
            }
        })
        .catch(error => {
            console.error('Error during AI analysis:', error);
            if (progressElement) {
                progressElement.classList.add('d-none');
            }
            alert('An error occurred during AI analysis. Please check the console for details.');
        });
    }

    function simulateAnalysis() {
        const steps = document.querySelectorAll('.analysis-steps .step');
        const progressBar = document.querySelector('.progress-bar');
        let currentStep = 0;

        if (!steps || steps.length === 0 || !progressBar) {
            console.warn('Analysis progress elements not found');
            return;
        }

        const interval = setInterval(() => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                const icon = step.querySelector('i');

                if (step) {
                    step.style.color = '#28a745';
                }
                if (icon) {
                    icon.className = 'fas fa-check-circle me-2';
                }

                currentStep++;
                if (progressBar) {
                    progressBar.style.width = (currentStep / steps.length * 100) + '%';
                }
            } else {
                clearInterval(interval);
            }
        }, 1000);
    }

    function showRecipePreview(recipeData) {
        console.log('showRecipePreview called with:', recipeData);
        
        // Generate preview HTML and show modal
        const previewContent = document.getElementById('recipePreviewContent');
        previewContent.innerHTML = generatePreviewHTML(recipeData);

        const modalElement = document.getElementById('recipePreviewModal');
        const modal = new bootstrap.Modal(modalElement);
        
        // Store recipe data globally BEFORE showing modal
        window.currentRecipeData = recipeData;
        
        // Use Bootstrap Modal Event 'shown.bs.modal' for reliable timing
        // This event fires AFTER the modal is fully visible
        modalElement.addEventListener('shown.bs.modal', function onModalShown() {
            console.log('Modal fully shown, initializing...');
            
            // Remove event listener to prevent multiple calls
            modalElement.removeEventListener('shown.bs.modal', onModalShown);
            
            // Attach event listeners
            attachDragAndDropEventListeners();
            
            // Check if this is a Mix recipe with base recipe and load base ingredients
            console.log('Checking for base recipe...', recipeData.base_recipe);
            console.log('has_base value:', recipeData.base_recipe?.has_base, 'type:', typeof recipeData.base_recipe?.has_base);
            
            // ROBUST CHECK: Accept both Boolean true and String "true"
            const hasBase = recipeData.base_recipe?.has_base === true || recipeData.base_recipe?.has_base === "true";
            
            if (recipeData.base_recipe && hasBase && recipeData.base_recipe.base_recipe_number) {
                console.log('Base recipe detected! Loading base ingredients...');
                loadBaseRecipeIngredients(recipeData.base_recipe.base_recipe_number, recipeData);
            } else {
                console.log('No base recipe detected. Details:', {
                    has_base_recipe_obj: !!recipeData.base_recipe,
                    has_base: hasBase,
                    has_recipe_number: !!recipeData.base_recipe?.base_recipe_number
                });
            }
        });
        
        // Show modal AFTER event listener is attached
        modal.show();
    }
    
    function loadBaseRecipeIngredients(baseRecipeNumber, currentRecipeData) {
        console.log('Loading base recipe ingredients for recipe number:', baseRecipeNumber);
        console.log('Current recipe data:', currentRecipeData);
        console.log('Current ingredients:', currentRecipeData.ingredients);
        
        // IDEMPOTENCE: Check if base ingredients already loaded (check for children, not top-level base ingredients)
        const alreadyLoaded = currentRecipeData.ingredients.some(ing => ing.children && ing.children.length > 0);
        console.log('Already loaded check:', alreadyLoaded);
        if (alreadyLoaded) {
            console.log('Base ingredients already loaded (children exist), skipping...');
            return;
        }
        
        // Show loading indicator
        const ingredientsTable = document.querySelector('#ingredientsList');
        if (ingredientsTable) {
            const loadingRow = document.createElement('tr');
            loadingRow.id = 'base-ingredients-loading';
            loadingRow.innerHTML = '<td colspan="2" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading base recipe ingredients...</td>';
            ingredientsTable.appendChild(loadingRow);
        }
        
        // Fetch base recipe from database
        fetch(`/api/recipe-number/${baseRecipeNumber}/product`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.product) {
                    const baseProduct = data.product;
                    console.log('Base recipe found:', baseProduct.name);
                    console.log('Base product data:', baseProduct);
                    
                    // Parse base ingredients - ROBUST: Accept both String (JSON) and Array
                    let baseIngredients = [];
                    if (Array.isArray(baseProduct.ingredients)) {
                        // Already an array from API
                        baseIngredients = baseProduct.ingredients;
                        console.log('Base ingredients (already array):', baseIngredients);
                    } else if (typeof baseProduct.ingredients === 'string') {
                        // JSON string - parse it
                        try {
                            baseIngredients = JSON.parse(baseProduct.ingredients || '[]');
                            console.log('Base ingredients (parsed from JSON):', baseIngredients);
                        } catch (e) {
                            console.error('Failed to parse base ingredients:', e);
                            baseIngredients = [];
                        }
                    } else {
                        console.warn('Base ingredients is neither array nor string:', baseProduct.ingredients);
                        baseIngredients = [];
                    }
                    
                    console.log(`Total base ingredients found: ${baseIngredients.length}`);
                    
                    // CRITICAL FIX: Find the base carrier ingredient by matching name or using metadata
                    let basePercentageInMix = 0;
                    let carrierIngredient = null;
                    
                    // Method 1: Try to find carrier by matching base recipe name (most reliable)
                    if (currentRecipeData.base_recipe && currentRecipeData.base_recipe.base_ingredient_name) {
                        const baseIngredientName = currentRecipeData.base_recipe.base_ingredient_name.toLowerCase();
                        carrierIngredient = currentRecipeData.ingredients.find(ing => 
                            ing.name.toLowerCase().includes(baseIngredientName) || 
                            baseIngredientName.includes(ing.name.toLowerCase())
                        );
                        if (carrierIngredient) {
                            basePercentageInMix = carrierIngredient.percentage / 100;
                            console.log(`Found base carrier by name match: ${carrierIngredient.name} at ${carrierIngredient.percentage}%`);
                        }
                    }
                    
                    // Method 2: Fallback - find ingredient with highest percentage (likely the base)
                    if (!carrierIngredient) {
                        carrierIngredient = currentRecipeData.ingredients.reduce((max, ing) => 
                            ing.percentage > (max?.percentage || 0) ? ing : max, null);
                        if (carrierIngredient) {
                            basePercentageInMix = carrierIngredient.percentage / 100;
                            console.log(`Found base carrier by highest percentage: ${carrierIngredient.name} at ${carrierIngredient.percentage}%`);
                        }
                    }
                    
                    // Method 3: Last resort - default to 100% if no carrier found
                    if (basePercentageInMix === 0) {
                        console.warn('Could not determine base carrier percentage, defaulting to 100%');
                        basePercentageInMix = 1.0;
                    }
                    
                    // NESTED DISPLAY: Add base ingredients as CHILDREN of the carrier ingredient
                    if (baseIngredients.length > 0 && carrierIngredient) {
                        // Mark current ingredients as "mix"
                        currentRecipeData.ingredients.forEach(ing => {
                            ing.type = 'mix';
                        });
                        
                        // Add base ingredients as CHILDREN of the carrier (nested display)
                        const baseChildren = baseIngredients.map(baseIng => {
                            // Scale base ingredient percentages by base percentage in mix
                            const scaledPercentage = (baseIng.percentage || 0) * basePercentageInMix;
                            
                            return {
                                name: baseIng.name,
                                percentage: parseFloat(scaledPercentage.toFixed(2)), // Round to 2 decimals
                                type: 'base',
                                base_recipe_name: baseProduct.name,
                                base_recipe_number: baseRecipeNumber
                            };
                        });
                        
                        // Attach base ingredients as children to the carrier ingredient
                        carrierIngredient.children = baseChildren;
                        carrierIngredient.has_children = true;
                        carrierIngredient.base_recipe_name = baseProduct.name;
                        carrierIngredient.base_recipe_number = baseRecipeNumber;
                        
                        // Update the global recipe data
                        window.currentRecipeData = currentRecipeData;
                        
                        // Regenerate the preview HTML with nested display
                        const previewContent = document.getElementById('recipePreviewContent');
                        previewContent.innerHTML = generatePreviewHTML(currentRecipeData);
                        
                        // Reattach event listeners
                        attachDragAndDropEventListeners();
                        
                        console.log(`Base ingredients added as children of ${carrierIngredient.name} (${baseChildren.length} items)`);
                    }
                } else {
                    console.warn('Base recipe not found in database');
                }
                
                // Remove loading indicator
                const loadingRow = document.getElementById('base-ingredients-loading');
                if (loadingRow) {
                    loadingRow.remove();
                }
            })
            .catch(error => {
                console.error('Error loading base recipe:', error);
                
                // Remove loading indicator
                const loadingRow = document.getElementById('base-ingredients-loading');
                if (loadingRow) {
                    loadingRow.remove();
                }
            });
    }

    // HTML escaping function to prevent XSS and DOM corruption
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function generatePreviewHTML(data) {
        let ingredientIndex = 0;
        
        // Don't filter ingredients - they should all be displayed
        // The base recipe loading will add children to the appropriate carrier ingredient
        const filteredIngredients = data.ingredients;
        
        console.log(`Generating preview HTML with ${filteredIngredients.length} ingredients`);
        
        const ingredientsHTML = filteredIngredients.map((ing) => {
            const currentIndex = ingredientIndex;
            ingredientIndex++;
            
            // Extract metadata for base recipe ingredients
            const ingredientType = ing.type || 'mix';
            const baseRecipeName = ing.base_recipe_name || '';
            const baseRecipeNumber = ing.base_recipe_number || '';
            const hasChildren = ing.has_children || (ing.children && ing.children.length > 0);
            
            // SECURITY: Escape all values before inserting into HTML
            const escapedName = escapeHtml(ing.name);
            const escapedType = escapeHtml(ingredientType);
            const escapedBaseRecipeName = escapeHtml(baseRecipeName);
            const escapedBaseRecipeNumber = escapeHtml(baseRecipeNumber);
            
            // Visual styling for mix ingredients with base recipe
            const badge = hasChildren 
                ? `<span class="badge bg-info text-white ms-2" title="Contains base recipe: ${escapeHtml(baseRecipeName)}">
                     <i class="fas fa-layer-group me-1"></i>BASE RECIPE
                   </span>` 
                : '';
            
            // Main ingredient row
            let html = `<tr class="draggable-ingredient" draggable="true" 
                        data-type="${escapedType}" 
                        data-base-recipe-name="${escapedBaseRecipeName}" 
                        data-base-recipe-number="${escapedBaseRecipeNumber}"
                        data-has-children="${hasChildren ? 'true' : 'false'}">
                <td>
                    <div class="input-group">
                        <span class="input-group-text drag-handle" style="cursor: move; display: inline-flex;">
                            <i class="fas fa-grip-vertical"></i>
                        </span>
                        <input type="text" class="form-control ingredient-name-input" 
                               value="${escapedName}" 
                               data-index="${currentIndex}" 
                               data-type="${escapedType}"
                               data-base-recipe-name="${escapedBaseRecipeName}"
                               data-base-recipe-number="${escapedBaseRecipeNumber}"
                               data-has-children="${hasChildren ? 'true' : 'false'}"
                               style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                        ${badge}
                    </div>
                </td>
                <td>
                    <div class="input-group">
                        <input type="number" class="form-control percentage-input text-end" 
                               value="${ing.percentage}" 
                               data-index="${currentIndex}" 
                               data-type="${escapedType}"
                               data-base-recipe-name="${escapedBaseRecipeName}"
                               data-base-recipe-number="${escapedBaseRecipeNumber}"
                               data-has-children="${hasChildren ? 'true' : 'false'}"
                               min="0" max="100" step="0.1"
                               style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem; min-width: 100px; width: 100px;">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-existing-ingredient-btn" data-index="${currentIndex}" style="display: inline-block;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
            
            // Add nested children rows (base ingredients) - INDENTED, ITALIC, SMALLER
            if (ing.children && ing.children.length > 0) {
                ing.children.forEach((child) => {
                    const childIndex = ingredientIndex;
                    ingredientIndex++;
                    
                    const escapedChildName = escapeHtml(child.name);
                    const escapedChildType = escapeHtml(child.type || 'base');
                    const escapedChildBaseRecipeName = escapeHtml(child.base_recipe_name || '');
                    const escapedChildBaseRecipeNumber = escapeHtml(child.base_recipe_number || '');
                    
                    html += `<tr class="draggable-ingredient base-ingredient-child" draggable="false" 
                                data-type="${escapedChildType}" 
                                data-base-recipe-name="${escapedChildBaseRecipeName}" 
                                data-base-recipe-number="${escapedChildBaseRecipeNumber}"
                                data-is-child="true"
                                style="background-color: #f8f9fa;">
                        <td style="padding-left: 50px;">
                            <div class="input-group">
                                <input type="text" class="form-control ingredient-name-input" 
                                       value="${escapedChildName}" 
                                       data-index="${childIndex}" 
                                       data-type="${escapedChildType}"
                                       data-base-recipe-name="${escapedChildBaseRecipeName}"
                                       data-base-recipe-number="${escapedChildBaseRecipeNumber}"
                                       data-is-child="true"
                                       readonly
                                       style="border: 1px solid #dee2e6; background: #f8f9fa; font-style: italic; font-size: 0.85rem; color: #6c757d; padding: 0.25rem 0.5rem;">
                            </div>
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input text-end" 
                                       value="${child.percentage}" 
                                       data-index="${childIndex}" 
                                       data-type="${escapedChildType}"
                                       data-base-recipe-name="${escapedChildBaseRecipeName}"
                                       data-base-recipe-number="${escapedChildBaseRecipeNumber}"
                                       data-is-child="true"
                                       readonly
                                       min="0" max="100" step="0.1"
                                       style="border: 1px solid #dee2e6; background: #f8f9fa; font-style: italic; font-size: 0.85rem; color: #6c757d; padding: 0.25rem 0.5rem; min-width: 100px; width: 100px;">
                                <span class="input-group-text" style="background: #f8f9fa; border: 1px solid #dee2e6; color: #adb5bd; font-size: 0.75rem;">
                                    <i class="fas fa-lock"></i>
                                </span>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            
            return html;
        }).join('');

        const allergensHTML = data.allergens.map((allergen, index) => {
            const escapedAllergen = escapeHtml(allergen);
            return `<div class="input-group mb-2 me-2 draggable-allergen" draggable="true" style="width: 100%; display: flex; margin-bottom: 8px;">
                <span class="input-group-text bg-warning text-dark drag-handle" style="cursor: move; display: inline-flex;">
                    <i class="fas fa-grip-vertical"></i>
                </span>
                <span class="input-group-text bg-warning text-dark">
                    <i class="fas fa-exclamation-triangle"></i>
                </span>
                <input type="text" class="form-control allergen-input" 
                       value="${escapedAllergen}" data-index="${index}"
                       style="flex: 1; white-space: normal; word-wrap: break-word; overflow: visible; border: 1px solid #ced4da; background: #fff; cursor: text; min-height: 38px; height: auto; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                <button type="button" class="btn btn-outline-danger btn-sm remove-existing-allergen-btn" data-index="${index}" style="display: inline-block;">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        }).join('');

        const claimsHTML = data.claims.map((claim, index) => {
            const escapedClaim = escapeHtml(claim);
            return `<div class="input-group mb-2 me-2 draggable-claim" draggable="true" style="width: 100%; display: flex; margin-bottom: 8px;">
                <span class="input-group-text bg-success text-white drag-handle" style="cursor: move; display: inline-flex;">
                    <i class="fas fa-grip-vertical"></i>
                </span>
                <span class="input-group-text bg-success text-white">
                    <i class="fas fa-check"></i>
                </span>
                <input type="text" class="form-control claim-input" 
                       value="${escapedClaim}" data-index="${index}" 
                       style="flex: 1; white-space: normal; word-wrap: break-word; overflow: visible; border: 1px solid #ced4da; background: #fff; cursor: text; min-height: 38px; height: auto; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                <button type="button" class="btn btn-outline-danger btn-sm remove-existing-claim-btn" data-index="${index}" style="display: inline-block;">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        }).join('');

        return `
            <div class="container-fluid p-4 recipe-preview-modal">
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="text-center mb-4">
                            <input type="text" id="recipeName" class="form-control text-center fs-3 fw-bold" 
                                   value="${escapeHtml(data.name)}" style="border: 1px solid #ced4da; background: #fff; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                            <textarea id="recipeDescription" class="form-control text-center text-muted mt-2" 
                                     rows="2" style="border: 1px solid #ced4da; background: #fff; padding: 0.375rem 0.75rem; border-radius: 0.375rem; resize: none;">${escapeHtml(data.description)}</textarea>
                            <select id="recipeCategory" class="form-select mt-3" style="width: 300px; margin: 0 auto; border: 1px solid #ced4da; background: #fff; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                                <option value="Flakes" ${data.category === 'Flakes' ? 'selected' : ''}>Flakes</option>
                                <option value="Multigrain & Branflakes" ${data.category === 'Multigrain & Branflakes' ? 'selected' : ''}>Multigrain & Branflakes</option>
                                <option value="Puffed Cereals" ${data.category === 'Puffed Cereals' ? 'selected' : ''}>Puffed Cereals</option>
                                <option value="Extrudates & Co-Extrudates" ${data.category === 'Extrudates & Co-Extrudates' ? 'selected' : ''}>Extrudates & Co-Extrudates</option>
                                <option value="Traditional Muesli" ${data.category === 'Traditional Muesli' ? 'selected' : ''}>Traditional Muesli</option>
                                <option value="Crunchy Muesli" ${data.category === 'Crunchy Muesli' ? 'selected' : ''}>Crunchy Muesli</option>
                                <option value="Bio & Fair-Trade Muesli" ${data.category === 'Bio & Fair-Trade Muesli' ? 'selected' : ''}>Bio & Fair-Trade Muesli</option>
                                <option value="Oat Flakes" ${data.category === 'Oat Flakes' ? 'selected' : ''}>Oat Flakes</option>
                                <option value="Wheat, Rye & Barley Flakes" ${data.category === 'Wheat, Rye & Barley Flakes' ? 'selected' : ''}>Wheat, Rye & Barley Flakes</option>
                                <option value="Bars" ${data.category === 'Bars' ? 'selected' : ''}>Bars</option>
                            </select>
                        </div>
                    </div>

                    <!-- Recipe Number Section -->
                    ${data.recipe_number ? `
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header" style="background-color: #661c31;">
                                <h5 class="mb-0 text-white">
                                    <i class="fas fa-hashtag me-2"></i>Rezeptnummer
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #f8f9fa;">
                                        <i class="fas fa-barcode text-muted"></i>
                                    </span>
                                    <input type="text" id="recipeNumber" class="form-control" 
                                           value="${data.recipe_number || ''}" 
                                           style="border: 1px solid #ced4da; background: #fff; padding: 0.375rem 0.75rem; border-radius: 0.375rem;">
                                    <span class="input-group-text" style="background-color: #f8f9fa; color: #6c757d;">
                                        extrahiert aus Dokument
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Additional Product Info Section (Exclusive, Department, Customer) -->
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header" style="background-color: #661c31;">
                                <h5 class="mb-0 text-white">
                                    <i class="fas fa-info-circle me-2"></i>Zus채tzliche Produktinformationen
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Exclusive</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="exclusiveCheck" 
                                                   ${data.exclusive === 'ja' ? 'checked' : ''}>
                                            <label class="form-check-label" for="exclusiveCheck">
                                                Exklusives Produkt
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="department" class="form-label fw-bold">Department</label>
                                        <input type="text" id="department" class="form-control" 
                                               value="${data.department || ''}" 
                                               placeholder="z.B. Production, R&D">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="customer" class="form-label fw-bold">Customer</label>
                                        <input type="text" id="customer" class="form-control" 
                                               value="${data.customer || ''}" 
                                               placeholder="Kundenname">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extracted Images Section -->
                    ${data.extracted_images && data.extracted_images.length > 0 ? `
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header" style="background-color: #661c31;">
                                <h5 class="mb-0 text-white">
                                    <i class="fas fa-images me-2"></i>Extrahierte Bilder aus Dokument (${data.extracted_images.length})
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">W채hlen Sie die Bilder aus, die als Produktbild und Nutri-Score-Bild verwendet werden sollen:</p>
                                <div class="row g-3" id="extractedImagesGrid">
                                    ${data.extracted_images.map((img, index) => `
                                        <div class="col-md-3">
                                            <div class="card image-selection-card" data-image-index="${index}" data-image-url="${img.url}">
                                                <div class="image-preview-container" style="height: 150px; overflow: hidden; position: relative;">
                                                    <img src="${img.url}" alt="Extracted Image ${index + 1}" 
                                                         style="width: 100%; height: 100%; object-fit: cover;">
                                                    <div class="image-selection-overlay position-absolute top-0 start-0 w-100 h-100" 
                                                         style="background: rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                                        <button type="button" class="btn btn-primary btn-sm mb-2 select-as-product-btn" 
                                                                data-image-url="${img.url}" data-image-index="${index}">
                                                            <i class="fas fa-box me-1"></i>Als Produktbild
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm select-as-nutri-btn" 
                                                                data-image-url="${img.url}" data-image-index="${index}">
                                                            <i class="fas fa-award me-1"></i>Als Nutri-Score
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body p-2">
                                                    <small class="text-muted d-block">${img.source}</small>
                                                    <small class="text-muted">${img.dimensions}</small>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Selected Images Section -->
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header" style="background-color: #661c31;">
                                <h5 class="mb-0 text-white">
                                    <i class="fas fa-check-circle me-2"></i>Ausgew채hlte Bilder
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Produktbild</label>
                                        <div class="image-upload-container position-relative">
                                            <div class="image-preview-wrapper" style="height: 200px; border: 2px dashed #ced4da; border-radius: 8px; overflow: hidden; position: relative; background: #f8f9fa;">
                                                <img id="productImagePreview" src="${data.image_url || '/static/images/product-placeholder.png'}" 
                                                     alt="Product Image" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="document.getElementById('productImageInput').click();">
                                                <div class="image-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s;">
                                                    <i class="fas fa-camera text-white fa-2x"></i>
                                                </div>
                                            </div>
                                            <input type="file" id="productImageInput" class="d-none" accept="image/*" data-image-type="product">
                                            <div class="mt-2 d-flex gap-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('productImageInput').click();">
                                                    <i class="fas fa-upload me-1"></i>Eigenes hochladen
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" id="clearProductImageBtn">
                                                    <i class="fas fa-times me-1"></i>Entfernen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Nutri-Score Bild</label>
                                        <div class="image-upload-container position-relative">
                                            <div class="image-preview-wrapper" style="height: 200px; border: 2px dashed #ced4da; border-radius: 8px; overflow: hidden; position: relative; background: #f8f9fa;">
                                                <img id="nutriScoreImagePreview" src="${data.nutri_score_image || '/static/images/placeholder-nutriscore.png'}" 
                                                     alt="Nutri-Score Image" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="document.getElementById('nutriScoreImageInput').click();">
                                                <div class="image-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s;">
                                                    <i class="fas fa-camera text-white fa-2x"></i>
                                                </div>
                                            </div>
                                            <input type="file" id="nutriScoreImageInput" class="d-none" accept="image/*" data-image-type="nutri_score">
                                            <div class="mt-2 d-flex gap-2">
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="document.getElementById('nutriScoreImageInput').click();">
                                                    <i class="fas fa-upload me-1"></i>Eigenes hochladen
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" id="clearNutriScoreImageBtn">
                                                    <i class="fas fa-times me-1"></i>Entfernen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Ingredients</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 70%;">Ingredient</th>
                                            <th style="width: 30%; text-align: right;">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ingredientsTableBody">${ingredientsHTML}</tbody>
                                </table>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addIngredientBtn">
                                        <i class="fas fa-plus me-1"></i>Add Ingredient
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Nutritional Information</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr><td class="fw-medium">Energy</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="energy" value="${data.nutritional_info.energy}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr><td class="fw-medium">Fat</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="fat" value="${data.nutritional_info.fat}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr class="table-light"><td class="ps-4">- of which saturated</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="saturated_fat" value="${data.nutritional_info.saturated_fat || 0}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr><td class="fw-medium">Carbohydrates</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="carbohydrates" value="${data.nutritional_info.carbohydrates}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr class="table-light"><td class="ps-4">- of which sugars</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="sugars" value="${data.nutritional_info.sugars || 0}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr><td class="fw-medium">Fiber</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="fiber" value="${data.nutritional_info.fiber}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr><td class="fw-medium">Protein</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="protein" value="${data.nutritional_info.protein}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                        <tr><td class="fw-medium">Salt</td><td class="text-end"><input type="number" class="form-control nutritional-input text-end" id="salt" value="${data.nutritional_info.salt}" step="0.1" style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem;"></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">Allergens</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2" id="allergensContainer" style="overflow: visible; word-wrap: break-word;">
                                    ${allergensHTML || '<span class="text-muted fst-italic" id="noAllergensText">No allergens detected</span>'}
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-warning btn-sm" id="addAllergenBtn">
                                        <i class="fas fa-plus me-1"></i>Add Allergen
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Product Claims</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2" id="claimsContainer" style="overflow: visible; word-wrap: break-word;">
                                    ${claimsHTML || '<span class="text-muted fst-italic" id="noClaimsText">No claims identified</span>'}
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" id="addClaimBtn">
                                        <i class="fas fa-plus me-1"></i>Add Claim
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-warehouse me-2"></i>Storage Conditions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Storage Conditions</label>
                                    <textarea id="storageConditions" class="form-control" rows="2" 
                                             placeholder="e.g. Store in a cool, dry place, protect from direct sunlight"
                                             style="border: 1px solid #ced4da; background: #fff; cursor: text; padding: 0.375rem 0.75rem; border-radius: 0.375rem; resize: vertical;">${data.storage_conditions || 'Store in a cool, dry place, protect from direct sunlight'}</textarea>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Product Images</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Product Image</label>
                                    <input type="file" class="form-control" id="productImageInput" accept="image/*">
                                    <div class="mt-2" id="productImagePreview" style="display: none;">
                                        <img id="productImagePreviewImg" src="" alt="Product Preview" class="img-fluid" style="max-height: 150px; border-radius: 8px;">
                                        <p class="text-success mt-1 mb-0"><i class="fas fa-check-circle me-1"></i>Product image uploaded successfully</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nutri-Score Image</label>
                                    <input type="file" class="form-control" id="nutriScoreImageInput" accept="image/*">
                                    <div class="mt-2" id="nutriScoreImagePreview" style="display: none;">
                                        <img id="nutriScoreImagePreviewImg" src="" alt="Nutri-Score Preview" class="img-fluid" style="max-height: 80px; border-radius: 8px;">
                                        <p class="text-success mt-1 mb-0"><i class="fas fa-check-circle me-1"></i>Nutri-Score image uploaded successfully</p>
                                    </div>
                                </div>
                                <div class="mb-3" id="currentImagesDisplay" style="display: none;">
                                    <h6 class="fw-bold">Currently Uploaded Images:</h6>
                                    <div class="row g-2">
                                        <div class="col-md-6" id="currentProductImageContainer" style="display: none;">
                                                                                        <div class="border rounded p-2">
                                                <label class="form-label text-muted small">Product Image</label>
                                                <img id="currentProductImage" src="" alt="Current Product Image" class="img-fluid" style="max-height: 120px; border-radius: 4px;">
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="currentNutriScoreContainer" style="display: none;">
                                            <div class="border rounded p-2">
                                                <label class="form-label text-muted small">Nutri-Score Image</label>
                                                <img id="currentNutriScoreImage" src="" alt="Current Nutri-Score Image" class="img-fluid" style="max-height: 120px; border-radius: 4px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Edit Recipe functionality
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'editRecipeBtn') {
            toggleEditMode(true);
        } else if (e.target && e.target.id === 'saveRecipeBtn') {
            saveRecipeChanges();
        } else if (e.target && e.target.id === 'publishRecipeBtn') {
            publishRecipe();
        }
    });

    function toggleEditMode(enableEdit) {
        const inputs = document.querySelectorAll('#recipePreviewContent input, #recipePreviewContent textarea, #recipePreviewContent select');
        const editBtn = document.getElementById('editRecipeBtn') || document.getElementById('cancelEditBtn');
        const saveBtn = document.getElementById('saveRecipeBtn');
        const removeButtons = document.querySelectorAll('.remove-existing-ingredient-btn, .remove-existing-allergen-btn, .remove-existing-claim-btn');
        const dragHandles = document.querySelectorAll('.drag-handle');
        const draggableItems = document.querySelectorAll('.draggable-ingredient, .draggable-allergen, .draggable-claim');

        inputs.forEach(input => {
            if (enableEdit) {
                // Enable editing completely
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                input.readOnly = false;
                input.disabled = false;

                // Style changes for edit mode
                input.style.border = '1px solid #ced4da';
                input.style.background = '#fff';
                input.style.cursor = 'text';
                input.style.padding = '0.375rem 0.75rem';
                input.style.borderRadius = '0.375rem';

                // Ensure full text is visible
                input.style.whiteSpace = 'normal';
                input.style.wordWrap = 'break-word';
                input.style.overflow = 'visible';
                input.style.textOverflow = 'unset';
                input.style.width = 'auto';
                input.style.minWidth = '200px';
                input.style.height = 'auto';
                input.style.minHeight = '38px';

                // Make inputs properly focusable
                input.tabIndex = 0;
                input.removeAttribute('contenteditable');
            } else {
                // View mode - readonly but visible
                input.readOnly = true;
                if (input.tagName === 'SELECT') {
                    input.disabled = true;
                }

                // Style changes for view mode
                input.style.border = 'none';
                input.style.background = 'transparent';
                input.style.cursor = 'default';
                input.style.padding = '0.375rem 0.75rem';

                // Ensure full text is always visible in view mode too
                input.style.whiteSpace = 'normal';
                input.style.wordWrap = 'break-word';
                input.style.overflow = 'visible';
                input.style.textOverflow = 'unset';
                input.style.width = 'auto';
                input.style.minWidth = '200px';
                input.style.height = 'auto';
                input.style.minHeight = '38px';
            }
        });

        // Toggle remove buttons visibility
        removeButtons.forEach(btn => {
            btn.style.display = enableEdit ? 'inline-block' : 'none';
        });

        // Toggle drag handles visibility and draggable functionality
        dragHandles.forEach(handle => {
            handle.style.display = enableEdit ? 'inline-flex' : 'none';
        });

        draggableItems.forEach(item => {
            item.setAttribute('draggable', enableEdit ? 'true' : 'false');
            if (enableEdit) {
                item.style.cursor = 'move';
                item.style.transition = 'all 0.3s ease';
                // Add event listeners for drag and drop
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            } else {
                item.style.cursor = 'default';
                // Remove event listeners
                item.removeEventListener('dragstart', handleDragStart);
                item.removeEventListener('dragover', handleDragOver);
                item.removeEventListener('drop', handleDrop);
                item.removeEventListener('dragend', handleDragEnd);
                item.removeEventListener('dragenter', handleDragEnter);
                item.removeEventListener('dragleave', handleDragLeave);
            }
        });

        if (enableEdit) {
            if (editBtn) {
                editBtn.innerHTML = '<i class="fas fa-times me-2"></i>Cancel Edit';
                editBtn.className = 'btn btn-outline-danger';
                editBtn.id = 'cancelEditBtn';
            }
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
        } else {
            if (editBtn) {
                editBtn.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Data';
                editBtn.className = 'btn btn-outline-warning';
                editBtn.id = 'editRecipeBtn';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'cancelEditBtn') {
            toggleEditMode(false);
            e.target.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Data';
            e.target.className = 'btn btn-outline-warning';
            e.target.id = 'editRecipeBtn';
        }
    });

    function saveRecipeChanges() {
        // Collect all edited data (preserve existing recipe_number and other metadata)
        const editedData = {
            name: document.getElementById('recipeName').value,
            description: document.getElementById('recipeDescription').value,
            category: document.getElementById('recipeCategory').value,
            ingredients: [],
            nutritional_info: {
                energy: document.getElementById('energy').value,
                fat: document.getElementById('fat').value,
                saturated_fat: document.getElementById('saturated_fat').value,
                carbohydrates: document.getElementById('carbohydrates').value,
                sugars: document.getElementById('sugars').value,
                fiber: document.getElementById('fiber').value,
                protein: document.getElementById('protein').value,
                salt: document.getElementById('salt').value
            },
            allergens: [],
            claims: [],
            // Preserve recipe_number from original data or form
            recipe_number: document.getElementById('recipeNumber')?.value || window.currentRecipeData?.recipe_number || null,
            // Preserve other metadata if available
            storage_conditions: document.getElementById('storageConditions')?.value || window.currentRecipeData?.storage_conditions || 'Store in a cool, dry place, protect from direct sunlight',
            extracted_images: window.currentRecipeData?.extracted_images || [],
            // New fields: Exclusive, Department, Customer
            exclusive: document.getElementById('exclusiveCheck')?.checked ? 'ja' : 'nein',
            department: document.getElementById('department')?.value || null,
            customer: document.getElementById('customer')?.value || null,
            // Preserve base_recipe metadata
            base_recipe: window.currentRecipeData?.base_recipe || {}
        };

        // Collect ingredients WITH METADATA from data-* attributes
        // IMPORTANT: Skip child ingredients (data-is-child="true") as they're part of their parent
        document.querySelectorAll('.ingredient-name-input').forEach((input) => {
            const isChild = input.getAttribute('data-is-child') === 'true';
            if (isChild) return; // Skip children, they're handled with their parent
            
            const index = input.getAttribute('data-index');
            const name = input.value;
            const percentageInput = document.querySelector(`.percentage-input[data-index="${index}"]`);
            const percentage = percentageInput ? parseFloat(percentageInput.value) || 0 : 0;
            
            // CRITICAL FIX: Extract metadata from data-* attributes
            const ingredientType = input.getAttribute('data-type') || 'mix';
            const baseRecipeName = input.getAttribute('data-base-recipe-name') || '';
            const baseRecipeNumber = input.getAttribute('data-base-recipe-number') || '';
            const hasChildren = input.getAttribute('data-has-children') === 'true';
            
            if (name.trim()) {
                const ingredient = { 
                    name: name.trim(), 
                    percentage: percentage 
                };
                
                // Add metadata
                if (ingredientType) {
                    ingredient.type = ingredientType;
                }
                if (baseRecipeName) {
                    ingredient.base_recipe_name = baseRecipeName;
                }
                if (baseRecipeNumber) {
                    ingredient.base_recipe_number = baseRecipeNumber;
                }
                if (hasChildren) {
                    ingredient.has_children = true;
                    
                    // Collect children from window.currentRecipeData if available
                    const currentIng = window.currentRecipeData?.ingredients?.find(ing => 
                        ing.name === ingredient.name && ing.has_children
                    );
                    if (currentIng && currentIng.children) {
                        ingredient.children = currentIng.children;
                    }
                }
                
                editedData.ingredients.push(ingredient);
            }
        });

        // Collect allergens
        document.querySelectorAll('.allergen-input').forEach(input => {
            if (input.value.trim()) {
                editedData.allergens.push(input.value.trim());
            }
        });

        // Collect claims
        document.querySelectorAll('.claim-input').forEach(input => {
            if (input.value.trim()) {
                editedData.claims.push(input.value.trim());
            }
        });

        // Store edited data globally for publishing
        window.currentRecipeData = editedData;

        // Switch back to view mode
        toggleEditMode(false);

        // Show success message
        const saveBtn = document.getElementById('saveRecipeBtn');
        const originalHTML = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
        saveBtn.className = 'btn btn-success';

        setTimeout(() => {
            saveBtn.innerHTML = originalHTML;
            saveBtn.className = 'btn btn-success';
        }, 2000);
    }

    function publishRecipe() {
        const recipeData = window.currentRecipeData || getCurrentRecipeData();


        if (!recipeData || !recipeData.name.trim()) {
            alert('Please ensure the recipe has a valid name before publishing.');
            return;
        }

        // Generate unique recipe ID to prevent overwriting
        recipeData.recipe_id = 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        recipeData.created_at = new Date().toISOString();

        // Get currently selected images from the preview
        const productImagePreview = document.getElementById('productImagePreview');
        const nutriScoreImagePreview = document.getElementById('nutriScoreImagePreview');
        
        if (productImagePreview && productImagePreview.src) {
            // Only use extracted/uploaded images, not placeholder images
            if (!productImagePreview.src.includes('images.unsplash.com')) {
                recipeData.image_url = productImagePreview.src.replace(window.location.origin, '');
            }
        }
        
        if (nutriScoreImagePreview && nutriScoreImagePreview.src) {
            // Only use extracted/uploaded images, not placeholder images  
            if (!nutriScoreImagePreview.src.includes('placeholder-nutriscore.png')) {
                recipeData.nutri_score_image = nutriScoreImagePreview.src.replace(window.location.origin, '');
            }
        }

        // CRITICAL FIX: Ensure base_recipe is properly included
        // Check if we have ingredients with children (base recipe structure) and construct base_recipe object
        const ingredientsWithChildren = recipeData.ingredients.filter(ing => ing.has_children);
        if (ingredientsWithChildren.length > 0 && !recipeData.base_recipe) {
            // Construct base_recipe from ingredient with children
            const parentIngredient = ingredientsWithChildren[0];
            recipeData.base_recipe = {
                has_base: true,
                base_recipe_number: parentIngredient.base_recipe_number || null,
                base_ingredient_name: parentIngredient.base_recipe_name || parentIngredient.name
            };
        }

        console.log('Publishing recipe with images and base_recipe:', {
            product_image: recipeData.image_url,
            nutri_score_image: recipeData.nutri_score_image,
            base_recipe: recipeData.base_recipe,
            ingredients_with_children: ingredientsWithChildren.length,
            total_ingredients: recipeData.ingredients.length
        });

        // Send to backend to create new recipe
        fetch('/api/publish-recipe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(recipeData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('New recipe published successfully with ID: ' + data.recipe_id);

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('recipePreviewModal'));
                modal.hide();

                // Redirect to competence page after 2 seconds to show the new recipe
                setTimeout(() => {
                    window.location.href = '/catalog?new_recipe=1';
                }, 2000);
            } else {
                alert('Error publishing recipe: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error publishing recipe. Please try again.');
        });
    }

    function getCurrentRecipeData() {
        // Extract current data from form fields WITH METADATA
        // IMPORTANT: Skip child ingredients, they're part of their parent
        const ingredients = Array.from(document.querySelectorAll('.ingredient-name-input'))
            .filter(input => input.getAttribute('data-is-child') !== 'true')
            .map((input) => {
                const index = input.getAttribute('data-index');
                const name = input.value;
                const percentageInput = document.querySelector(`.percentage-input[data-index="${index}"]`);
                const percentage = percentageInput ? parseFloat(percentageInput.value) || 0 : 0;
                
                // Extract metadata from data-* attributes
                const ingredientType = input.getAttribute('data-type') || '';
                const baseRecipeName = input.getAttribute('data-base-recipe-name') || '';
                const baseRecipeNumber = input.getAttribute('data-base-recipe-number') || '';
                const hasChildren = input.getAttribute('data-has-children') === 'true';
                
                const ingredient = { name, percentage };
                
                // Add metadata if present
                if (ingredientType) {
                    ingredient.type = ingredientType;
                }
                if (baseRecipeName) {
                    ingredient.base_recipe_name = baseRecipeName;
                }
                if (baseRecipeNumber) {
                    ingredient.base_recipe_number = baseRecipeNumber;
                }
                if (hasChildren) {
                    ingredient.has_children = true;
                    
                    // Collect children from window.currentRecipeData if available
                    const currentIng = window.currentRecipeData?.ingredients?.find(ing => 
                        ing.name === ingredient.name && ing.has_children
                    );
                    if (currentIng && currentIng.children) {
                        ingredient.children = currentIng.children;
                    }
                }
                
                return ingredient;
            }).filter(ing => ing.name.trim());
        
        // Check if we have ingredients with children (base recipe structure) and construct base_recipe object
        const ingredientsWithChildren = ingredients.filter(ing => ing.has_children);
        const base_recipe = ingredientsWithChildren.length > 0 ? {
            has_base: true,
            base_recipe_number: ingredientsWithChildren[0].base_recipe_number || null,
            base_ingredient_name: ingredientsWithChildren[0].base_recipe_name || ingredientsWithChildren[0].name
        } : {};
        
        return {
            name: document.getElementById('recipeName')?.value || '',
            description: document.getElementById('recipeDescription')?.value || '',
            category: document.getElementById('recipeCategory')?.value || 'Traditional Swiss Muesli',
            ingredients: ingredients,
            nutritional_info: {
                energy: document.getElementById('energy')?.value || 0,
                fat: document.getElementById('fat')?.value || 0,
                saturated_fat: document.getElementById('saturated_fat')?.value || 0,
                carbohydrates: document.getElementById('carbohydrates')?.value || 0,
                sugars: document.getElementById('sugars')?.value || 0,
                fiber: document.getElementById('fiber')?.value || 0,
                protein: document.getElementById('protein')?.value || 0,
                salt: document.getElementById('salt')?.value || 0
            },
            allergens: Array.from(document.querySelectorAll('.allergen-input')).map(input => input.value.trim()).filter(Boolean),
            claims: Array.from(document.querySelectorAll('.claim-input')).map(input => input.value.trim()).filter(Boolean),
            storage_conditions: document.getElementById('storageConditions')?.value || 'K체hl und trocken lagern, vor direkter Sonneneinstrahlung sch체tzen',
            recipe_number: document.getElementById('recipeNumber')?.value || null,
            exclusive: document.getElementById('exclusiveCheck')?.checked ? 'ja' : 'nein',
            department: document.getElementById('department')?.value || null,
            customer: document.getElementById('customer')?.value || null,
            base_recipe: base_recipe
        };
    }

    // Add functionality for dynamic add buttons and remove buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'addIngredientBtn') {
            addNewIngredient();
        } else if (e.target && e.target.id === 'addAllergenBtn') {
            addNewAllergen();
        } else if (e.target && e.target.id === 'addClaimBtn') {
            addNewClaim();
        } else if (e.target && e.target.classList.contains('remove-existing-ingredient-btn')) {
            removeExistingIngredient(e.target);
        } else if (e.target && e.target.classList.contains('remove-existing-allergen-btn')) {
            removeExistingAllergen(e.target);
        } else if (e.target && e.target.classList.contains('remove-existing-claim-btn')) {
            removeExistingClaim(e.target);
        }
    });

    // Delete recipe functionality
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('delete-recipe-btn')) {
            const recipeId = e.target.getAttribute('data-recipe-id');
            const recipeName = e.target.getAttribute('data-recipe-name') || 'this recipe';
            if (confirm(`Are you sure you want to delete "${recipeName}"? This action cannot be undone.`)) {
                deleteRecipe(recipeId);
            }
        }
    });

    function deleteRecipe(recipeId) {
        fetch(`/api/delete-recipe/${recipeId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the recipe card from the UI
                const recipeCard = document.getElementById(`recipe-${recipeId}`);
                if (recipeCard) {
                    recipeCard.remove();
                }

                // Check if there are no more recipes
                const recipesGrid = document.getElementById('recipesGrid');
                if (recipesGrid && recipesGrid.children.length === 0) {
                    const recipesList = document.getElementById('recipesList');
                    recipesList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No recipes found</h5>
                            <p class="text-muted">Upload your first recipe document to get started!</p>
                        </div>
                    `;
                }

                alert('Recipe deleted successfully');
            } else {
                alert('Error deleting recipe: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting recipe. Please try again.');
        });
    }

    // Image upload handlers
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'productImageInput') {
            handleImageUpload(e.target, 'productImagePreview', 'productImagePreviewImg', 'product');
        } else if (e.target && e.target.id === 'nutriScoreImageInput') {
            handleImageUpload(e.target, 'nutriScoreImagePreview', 'nutriScoreImagePreviewImg', 'nutriscore');
        }
    });

    function handleImageUpload(input, previewDivId, previewImgId, imageType) {
        const file = input.files[0];
        if (file) {
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a valid image file (JPG, PNG, GIF, or WebP)');
                input.value = '';
                return;
            }

            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('Image file is too large. Please upload an image smaller than 5MB.');
                input.value = '';
                return;
            }

            // Show preview
            const previewDiv = document.getElementById(previewDivId);
            const previewImg = document.getElementById(previewImgId);

            if (previewDiv && previewImg) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.style.maxWidth = '100%';
                    previewImg.style.height = 'auto';
                    previewDiv.style.display = 'block';

                    // Store image data for later use
                    if (imageType === 'product') {
                        window.uploadedProductImage = e.target.result;
                    } else if (imageType === 'nutriscore') {
                        window.uploadedNutriScoreImage = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }

            // Upload image to server
            uploadImageToServer(file, imageType);
        }
    }

    function uploadImageToServer(file, imageType) {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('image_type', imageType);

        // Show upload progress
        const previewDiv = document.getElementById(imageType === 'product' ? 'productImagePreview' : 'nutriScoreImagePreview');
        if (previewDiv) {
            const progressText = document.createElement('p');
            progressText.textContent = 'Uploading...';
            progressText.className = 'text-info mt-1 mb-0 upload-progress';
            previewDiv.appendChild(progressText);
        }

        fetch('/api/upload-recipe-image', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Remove progress indicator
            const progressIndicator = document.querySelector('.upload-progress');
            if (progressIndicator) {
                progressIndicator.remove();
            }

            if (data.success) {
                // Store the server URL for later use
                if (imageType === 'product') {
                    window.uploadedProductImageUrl = data.image_url;
                    updateCurrentImageDisplay('product', data.image_url);
                } else if (imageType === 'nutriscore') {
                    window.uploadedNutriScoreImageUrl = data.image_url;
                    updateCurrentImageDisplay('nutriscore', data.image_url);
                }
                console.log(`${imageType} image uploaded successfully:`, data.image_url);

                // Show success message
                if (previewDiv) {
                    const successText = document.createElement('p');
                    successText.innerHTML = '<i class="fas fa-check-circle me-1"></i>' + data.message;
                    successText.className = 'text-success mt-1 mb-0';
                    previewDiv.appendChild(successText);
                }
            } else {
                console.error('Image upload failed:', data.error);
                alert(`Failed to upload ${imageType} image: ${data.error}`);
            }
        })
        .catch(error => {
            // Remove progress indicator
            const progressIndicator = document.querySelector('.upload-progress');
            if (progressIndicator) {
                progressIndicator.remove();
            }

            console.error('Image upload error:', error);
            alert(`Error uploading ${imageType} image. Please try again.`);
        });
    }

    function updateCurrentImageDisplay(imageType, imageUrl) {
        const currentImagesDisplay = document.getElementById('currentImagesDisplay');

        if (imageType === 'product') {
            const container = document.getElementById('currentProductImageContainer');
            const img = document.getElementById('currentProductImage');
            if (container && img) {
                img.src = imageUrl;
                container.style.display = 'block';
                currentImagesDisplay.style.display = 'block';
            }
        } else if (imageType === 'nutriscore') {
            const container = document.getElementById('currentNutriScoreContainer');
            const img = document.getElementById('currentNutriScoreImage');
            if (container && img) {
                img.src = imageUrl;
                container.style.display = 'block';
                currentImagesDisplay.style.display = 'block';
            }
        }
    }

    function addNewIngredient() {
        const tbody = document.getElementById('ingredientsTableBody');
        const index = document.querySelectorAll('.ingredient-name-input').length;
        const newRow = document.createElement('tr');
        newRow.className = 'draggable-ingredient';
        newRow.setAttribute('draggable', 'true');
        // New ingredients are always "mix" type by default
        newRow.setAttribute('data-type', 'mix');
        newRow.setAttribute('data-base-recipe-name', '');
        newRow.setAttribute('data-base-recipe-number', '');
        newRow.innerHTML = `
            <td>
                <div class="input-group">
                    <span class="input-group-text drag-handle" style="cursor: move;">
                        <i class="fas fa-grip-vertical"></i>
                    </span>
                    <input type="text" class="form-control ingredient-name-input" 
                           value="" 
                           data-index="${index}" 
                           data-type="mix"
                           data-base-recipe-name=""
                           data-base-recipe-number=""
                           placeholder="Enter ingredient name">
                </div>
            </td>
            <td>
                <div class="input-group">
                    <input type="number" class="form-control percentage-input text-end" 
                           value="0" 
                           data-index="${index}" 
                           data-type="mix"
                           data-base-recipe-name=""
                           data-base-recipe-number=""
                           min="0" max="100" step="0.1" 
                           style="min-width: 100px; width: 100px;">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(newRow);

        // Add drag functionality
        newRow.addEventListener('dragstart', handleDragStart);
        newRow.addEventListener('dragover', handleDragOver);
        newRow.addEventListener('drop', handleDrop);
        newRow.addEventListener('dragend', handleDragEnd);

        // Add remove functionality
        newRow.querySelector('.remove-ingredient-btn').addEventListener('click', function() {
            newRow.remove();
        });
    }

    function addNewAllergen() {
        const container = document.getElementById('allergensContainer');
        const noAllergensText = document.getElementById('noAllergensText');
        if (noAllergensText) noAllergensText.style.display = 'none';

        const index = document.querySelectorAll('.allergen-input').length;
        const wrapper = document.createElement('div');
        wrapper.className = 'input-group mb-2 me-2 draggable-allergen';
        wrapper.style.width = '100%';
        wrapper.style.display = 'flex';
        wrapper.style.marginBottom = '8px';
        wrapper.setAttribute('draggable', 'true');
        wrapper.innerHTML = `
            <span class="input-group-text bg-warning text-dark drag-handle" style="cursor: move;">
                <i class="fas fa-grip-vertical"></i>
            </span>
            <span class="input-group-text bg-warning text-dark">
                <i class="fas fa-exclamation-triangle"></i>
            </span>
            <input type="text" class="form-control allergen-input" 
                   value="" data-index="${index}" placeholder="Enter allergen" 
                   style="flex: 1; white-space: normal; word-wrap: break-word; overflow: visible; min-height: 38px; height: auto;">
            <button type="button" class="btn btn-outline-danger btn-sm remove-allergen-btn">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(wrapper);

        // Add drag functionality
        wrapper.addEventListener('dragstart', handleDragStart);
        wrapper.addEventListener('dragover', handleDragOver);
        wrapper.addEventListener('drop', handleDrop);
        wrapper.addEventListener('dragend', handleDragEnd);
        wrapper.addEventListener('dragenter', handleDragEnter);
        wrapper.addEventListener('dragleave', handleDragLeave);

        // Add remove functionality
        wrapper.querySelector('.remove-allergen-btn').addEventListener('click', function() {
            wrapper.remove();
            if (document.querySelectorAll('.allergen-input').length === 0 && noAllergensText) {
                noAllergensText.style.display = 'inline';
            }
        });
    }

    function addNewClaim() {
        const container = document.getElementById('claimsContainer');
        const noClaimsText = document.getElementById('noClaimsText');
        if (noClaimsText) noClaimsText.style.display = 'none';

        const index = document.querySelectorAll('.claim-input').length;
        const wrapper = document.createElement('div');
        wrapper.className = 'input-group mb-2 me-2 draggable-claim';
        wrapper.style.width = '100%';
        wrapper.style.display = 'flex';
        wrapper.style.marginBottom = '8px';
        wrapper.setAttribute('draggable', 'true');
        wrapper.innerHTML = `
            <span class="input-group-text bg-success text-white drag-handle" style="cursor: move;">
                <i class="fas fa-grip-vertical"></i>
            </span>
            <span class="input-group-text bg-success text-white">
                <i class="fas fa-check"></i>
            </span>
            <input type="text" class="form-control claim-input" 
                   value="" data-index="${index}" placeholder="Enter claim" 
                   style="flex: 1; white-space: normal; word-wrap: break-word; overflow: visible; min-height: 38px; height: auto;">
            <button type="button" class="btn btn-outline-danger btn-sm remove-claim-btn">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(wrapper);

        // Add drag functionality
        wrapper.addEventListener('dragstart', handleDragStart);
        wrapper.addEventListener('dragover', handleDragOver);
        wrapper.addEventListener('drop', handleDrop);
        wrapper.addEventListener('dragend', handleDragEnd);
        wrapper.addEventListener('dragenter', handleDragEnter);
        wrapper.addEventListener('dragleave', handleDragLeave);

        // Add remove functionality
        wrapper.querySelector('.remove-claim-btn').addEventListener('click', function() {
            wrapper.remove();
            if (document.querySelectorAll('.claim-input').length === 0 && noClaimsText) {
                noClaimsText.style.display = 'inline';
            }
        });
    }

    // Remove functions for existing items
    function removeExistingIngredient(button) {
        const row = button.closest('tr');
        if (row) {
            row.remove();
        }
    }

    function removeExistingAllergen(button) {
        const container = button.closest('.input-group');
        if (container) {
            container.remove();
            // Show "no allergens" text if all are removed
            const allergensContainer = document.getElementById('allergensContainer');
            const noAllergensText = document.getElementById('noAllergensText');
            if (allergensContainer && allergensContainer.querySelectorAll('.allergen-input').length === 0 && noAllergensText) {
                noAllergensText.style.display = 'inline';
            }
        }
    }

    function removeExistingClaim(button) {
        const container = button.closest('.input-group');
        if (container) {
            container.remove();
            // Show "no claims" text if all are removed
            const claimsContainer = document.getElementById('claimsContainer');
            const noClaimsText = document.getElementById('noClaimsText');
            if (claimsContainer && claimsContainer.querySelectorAll('.claim-input').length === 0 && noClaimsText) {
                noClaimsText.style.display = 'inline';
            }
        }
    }

    // Drag and Drop functionality
    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
        this.style.transform = 'rotate(2deg)';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }

    function handleDragEnter(e) {
        e.preventDefault();
        if (draggedElement !== this && draggedElement && this) {
            const draggedType = getDraggedItemType(draggedElement);
            const targetType = getDraggedItemType(this);
            if (draggedType === targetType) {
                this.style.borderTop = '3px solid #007bff';
            }
        }
    }

    function handleDragLeave(e) {
        this.style.borderTop = '';
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        e.preventDefault();

        // Remove visual feedback
        this.style.borderTop = '';

        if (draggedElement !== this && draggedElement && this) {
            // Check if they're the same type
            const draggedType = getDraggedItemType(draggedElement);
            const targetType = getDraggedItemType(this);

            if (draggedType === targetType) {
                // Insert the dragged element before the target
                this.parentNode.insertBefore(draggedElement, this);

                // Re-index the elements
                reindexElements(draggedType);
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        if (draggedElement) {
            draggedElement.style.opacity = '1';
            draggedElement.style.transform = '';
            draggedElement = null;
        }
        // Remove all border indicators
        document.querySelectorAll('.draggable-ingredient, .draggable-allergen, .draggable-claim').forEach(el => {
            el.style.borderTop = '';
        });
    }

    function getDraggedItemType(element) {
        if (element.classList.contains('draggable-ingredient')) return 'ingredient';
        if (element.classList.contains('draggable-allergen')) return 'allergen';
        if (element.classList.contains('draggable-claim')) return 'claim';
        return null;
    }

    function reindexElements(type) {
        let selector, inputSelector;
        if (type === 'ingredient') {
            selector = '.draggable-ingredient';
            inputSelector = '.ingredient-name-input, .percentage-input';
        } else if (type === 'allergen') {
            selector = '.draggable-allergen';
            inputSelector = '.allergen-input';
        } else if (type === 'claim') {
            selector = '.draggable-claim';
            inputSelector = '.claim-input';
        }

        const elements = document.querySelectorAll(selector);
        elements.forEach((element, index) => {
            const inputs = element.querySelectorAll(inputSelector);
            inputs.forEach(input => {
                input.setAttribute('data-index', index);
            });
        });
    }

    // Function to attach drag and drop event listeners to all draggable elements
    function attachDragAndDropEventListeners() {
        const draggableItems = document.querySelectorAll('.draggable-ingredient, .draggable-allergen, .draggable-claim');

        draggableItems.forEach(item => {
            // Remove existing listeners first to avoid duplicates
            item.removeEventListener('dragstart', handleDragStart);
            item.removeEventListener('dragover', handleDragOver);
            item.removeEventListener('drop', handleDrop);
            item.removeEventListener('dragend', handleDragEnd);
            item.removeEventListener('dragenter', handleDragEnter);
            item.removeEventListener('dragleave', handleDragLeave);

            // Add fresh event listeners
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
            item.addEventListener('dragenter', handleDragEnter);
            item.addEventListener('dragleave', handleDragLeave);
        });

        // Setup image upload functionality after showing preview
        setupImageUploadHandlers();
    }

    // Image upload and swapping functionality
    function setupImageUploadHandlers() {
        // Handle product image upload
        const productImageInput = document.getElementById('productImageInput');
        const nutriScoreImageInput = document.getElementById('nutriScoreImageInput');
        
        if (productImageInput) {
            productImageInput.addEventListener('change', function(e) {
                handleImageUpload(e, 'product');
            });
        }
        
        if (nutriScoreImageInput) {
            nutriScoreImageInput.addEventListener('change', function(e) {
                handleImageUpload(e, 'nutri_score');
            });
        }
        
        // Handle image selection from extracted images
        const selectAsProductBtns = document.querySelectorAll('.select-as-product-btn');
        const selectAsNutriBtns = document.querySelectorAll('.select-as-nutri-btn');
        
        selectAsProductBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const imageUrl = this.dataset.imageUrl;
                selectImageAs('product', imageUrl);
            });
        });
        
        selectAsNutriBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const imageUrl = this.dataset.imageUrl;
                selectImageAs('nutri_score', imageUrl);
            });
        });
        
        // Handle clear image buttons
        const clearProductImageBtn = document.getElementById('clearProductImageBtn');
        const clearNutriScoreImageBtn = document.getElementById('clearNutriScoreImageBtn');
        
        if (clearProductImageBtn) {
            clearProductImageBtn.addEventListener('click', function() {
                clearSelectedImage('product');
            });
        }
        
        if (clearNutriScoreImageBtn) {
            clearNutriScoreImageBtn.addEventListener('click', function() {
                clearSelectedImage('nutri_score');
            });
        }
    }
    
    function handleImageUpload(event, imageType) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Show loading state
        const previewId = imageType === 'product' ? 'productImagePreview' : 'nutriScoreImagePreview';
        const preview = document.getElementById(previewId);
        if (preview) {
            preview.style.opacity = '0.5';
        }
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('image_type', imageType);
        
        fetch('/api/upload-recipe-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the preview image
                if (preview) {
                    preview.src = data.image_url;
                    preview.style.opacity = '1';
                }
                
                // Update the stored recipe data
                if (window.currentRecipeData) {
                    if (imageType === 'product') {
                        window.currentRecipeData.image_url = data.image_url;
                    } else {
                        window.currentRecipeData.nutri_score_image = data.image_url;
                    }
                }
                
                console.log(`${imageType} image uploaded successfully:`, data.image_url);
            } else {
                console.error('Image upload failed:', data.error);
                if (preview) {
                    preview.style.opacity = '1';
                }
                alert('Image upload failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Image upload error:', error);
            if (preview) {
                preview.style.opacity = '1';
            }
            alert('An error occurred during image upload.');
        });
    }
    
    function selectImageAs(type, imageUrl) {
        const previewId = type === 'product' ? 'productImagePreview' : 'nutriScoreImagePreview';
        const preview = document.getElementById(previewId);
        
        if (preview) {
            preview.src = imageUrl;
            
            // Update stored recipe data
            if (window.currentRecipeData) {
                if (type === 'product') {
                    window.currentRecipeData.image_url = imageUrl;
                } else {
                    window.currentRecipeData.nutri_score_image = imageUrl;
                }
            }
            
            console.log(`Selected image as ${type}:`, imageUrl);
        }
    }
    
    function clearSelectedImage(type) {
        const previewId = type === 'product' ? 'productImagePreview' : 'nutriScoreImagePreview';
        const preview = document.getElementById(previewId);
        
        if (preview) {
            const defaultUrl = type === 'product' ? 
                '/static/images/product-placeholder.png' : 
                '/static/images/placeholder-nutriscore.png';
            
            preview.src = defaultUrl;
            
            // Update stored recipe data
            if (window.currentRecipeData) {
                if (type === 'product') {
                    window.currentRecipeData.image_url = defaultUrl;
                } else {
                    window.currentRecipeData.nutri_score_image = null;
                }
            }
            
            console.log(`Cleared ${type} image`);
        }
    }
});

// Drag and drop handlers
function dragOverHandler(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('border-primary');
}

function dragLeaveHandler(ev) {
    ev.currentTarget.classList.remove('border-primary');
}

function dropHandler(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('border-primary');

    const files = ev.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('recipeFile').files = files;
        handleFileSelect(files);
    }
}
</script>
{% endblock %}